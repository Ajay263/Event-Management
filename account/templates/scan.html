{% extends "base.html" %}

{% block title %} Barcode Scanner {% endblock %}

{% block content %}
<form method="POST">
  {% csrf_token %}
  <!-- Other form fields -->
  <input type="hidden" name="current_url" value="{{ current_url }}" />
  <!-- Submit button -->
</form>

<input id="barcodeInput" type="text" autofocus />
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
  $(document).ready(function () {
    $("#barcodeInput").on("input", function () {
      var barcodeValue = $(this).val();
      if (barcodeValue) {
        $.ajax({
          url: "",
          method: "POST",
          data: {
            csrfmiddlewaretoken: $("[name=csrfmiddlewaretoken]").val(),
            barcode_value: barcodeValue,
          },
          success: function (response) {
            console.log(response); // Log the response to inspect its content

            try {
              var jsonResponse = JSON.parse(JSON.stringify(response));
              if (jsonResponse.message) {
                $("#message").text(jsonResponse.message);
              } else {
                $("#message").text("");
              }
              if (jsonResponse.time_taken) {
                $("#timeTaken").text(jsonResponse.time_taken);
              } else {
                $("#timeTaken").text("");
              }
              if (jsonResponse.error) {
                $("#error").text(jsonResponse.error);
              } else {
                $("#error").text("");
              }
            } catch (error) {
              console.log("Error parsing JSON response:", error);
            }
          },
          error: function (xhr, status, error) {
            // Handle the error response
            console.log(error);
            $("#message").text("");
            $("#timeTaken").text("");
            $("#error").text("An error occurred while processing the request.");
          },
        });
      }
    });
  });
</script> 


<script type="text/javascript"  src="/js/instascan.min.js"></script>
<script>
  $(document).ready(function () {
    // Initialize Instascan
    let scanner = new Instascan.Scanner({ video: document.getElementById('scanner') });

    // Configure Instascan
    scanner.addListener('scan', function (content) {
      // Content contains the scanned barcode value
      $.ajax({
        url: "",
        method: "POST",
        data: {
          csrfmiddlewaretoken: $("[name=csrfmiddlewaretoken]").val(),
          barcode_value: content,
        },
        success: function (response) {
          console.log(response); // Log the response to inspect its content

          try {
            var jsonResponse = JSON.parse(JSON.stringify(response));
            if (jsonResponse.message) {
              $("#message").text(jsonResponse.message);
            } else {
              $("#message").text("");
            }
            if (jsonResponse.time_taken) {
              $("#timeTaken").text(jsonResponse.time_taken);
            } else {
              $("#timeTaken").text("");
            }
            if (jsonResponse.error) {
              $("#error").text(jsonResponse.error);
            } else {
              $("#error").text("");
            }
          } catch (error) {
            console.log("Error parsing JSON response:", error);
          }
        },
        error: function (xhr, status, error) {
          // Handle the error response
          console.log(error);
          $("#message").text("");
          $("#timeTaken").text("");
          $("#error").text("An error occurred while processing the request.");
        },
      });
    });

    // Start the camera scanning
    Instascan.Camera.getCameras().then(function (cameras) {
      if (cameras.length > 0) {
        scanner.start(cameras[0]);
      } else {
        console.error('No cameras found.');
      }
    });
  });
</script>


<video id="scanner"></video>
<div id="message" style="color:green"></div>
<div id="timeTaken"></div>
<div id="error" style="color:brown;"></div>

{% endblock %}
