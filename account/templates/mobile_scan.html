<!DOCTYPE html>
<html>
<head>
  <title>Mobile Scan</title>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/quagga/dist/quagga.min.js"></script>
  <style>
    #scanner-container {
      position: relative;
      width: 100%;
      height: 100%;
    }
    #scanner {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    #camera-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      pointer-events: none;
    }
  </style>
</head>
<body>
  <div id="scanner-container">
    <video id="scanner"></video>
    <canvas id="camera-overlay"></canvas>
  </div>
  <div id="message" style="color: green;"></div>
  <div id="timeTaken"></div>
  <div id="error" style="color: brown;"></div>

  <script>
    $(document).ready(function() {
      var scannerContainer = document.getElementById("scanner-container");
      var scanner = document.getElementById("scanner");
      var cameraOverlay = document.getElementById("camera-overlay");
      var context = cameraOverlay.getContext("2d");

      // Configure QuaggaJS
      Quagga.init({
        inputStream: {
          name: "Live",
          type: "LiveStream",
          constraints: {
            facingMode: "environment", // Or "user" for front camera
          },
          target: scanner,
        },
        decoder: {
          readers: ["code_39_reader"],
        },
      }, function(err) {
        if (err) {
          console.error("Error initializing Quagga:", err);
          return;
        }
        // Start QuaggaJS
        Quagga.start();

        // Draw camera stream on overlay canvas
        Quagga.onProcessed(function(result) {
          var drawingCtx = Quagga.canvas.ctx.overlay;
          var drawingCanvas = Quagga.canvas.dom.overlay;

          if (result) {
            if (result.boxes) {
              drawingCtx.clearRect(0, 0, parseInt(drawingCanvas.getAttribute("width")), parseInt(drawingCanvas.getAttribute("height")));
              result.boxes.forEach(function(box) {
                if (box !== result.box) {
                  Quagga.ImageDebug.drawPath(box, { x: 0, y: 1 }, drawingCtx, { color: "green", lineWidth: 2 });
                }
              });
            }

            if (result.codeResult && result.codeResult.code) {
              Quagga.ImageDebug.drawPath(result.line, { x: "x", y: "y" }, drawingCtx, { color: "red", lineWidth: 3 });
            }
          }
        });
      });

      // Register event listeners
      Quagga.onDetected(function(result) {
        var barcodeValue = result.codeResult.code;
        $.ajax({
          url: window.location.href,
          method: "POST",
          data: {
            csrfmiddlewaretoken: $("[name=csrfmiddlewaretoken]").val(),
            barcode_value: barcodeValue,
          },
          success: function(response) {
            console.log(response); // Log the response to inspect its content

            try {
              var jsonResponse = JSON.parse(JSON.stringify(response));
              if (jsonResponse.message) {
                $("#message").text(jsonResponse.message);
              } else {
                $("#message").text("");
              }
              if (jsonResponse.time_taken) {
                $("#timeTaken").text(jsonResponse.time_taken);
              } else {
                $("#timeTaken").text("");
              }
              if (jsonResponse.error) {
                $("#error").text(jsonResponse.error);
              } else {
                $("#error").text("");
              }
            } catch (error) {
              console.log("Error parsing JSON response:", error);
            }
          },
          error: function(xhr, status, error) {
            // Handle the error response
            console.log(error);
            $("#message").text("");
            $("#timeTaken").text("");
            $("#error").text("An error occurred while processing the request.");
          },
        });
      });
    });
  </script>
</body>
</html>